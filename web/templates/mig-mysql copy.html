<ol class="breadcrumb mb-1" style="margin-top: 66px;">
    <li class="breadcrumb-item">Migration</li>
</ol>
<h2 class="page-title">SQL Database</h2>

<div class="card rounded-3 mb-4 col-auto">
    <ul class="nav nav-tabs pt-2 ps-2">
        <li class="nav-item">
            <a class="nav-link" href="/migrate/objectstorage">Object Storage</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="#">
                SQL Database
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/migrate/no-sql">No-SQL</a>
        </li>
    </ul>
    <div class="card-body">
        <form id="migForm">
            <input type="hidden" id="migService" value="rdbms">
            <input type="hidden" id="migSource" value="mysql">
            <input type="hidden" id="migDest" value="mysql">
            <div class="stepper d-flex flex-column mt-2 ml-2">
                <div class="d-flex mb-1">
                    <div class="d-flex flex-column pr-4 align-items-center mt-2">
                        <button class="rounded-circle py-2 px-3 bg-secondary text-white mb-1 next-btn border-0 step-btn" type="button" data-target="#collapseOne">
                            1
                        </button>
                        <!-- <div class="rounded-circle py-2 px-3 bg-secondary text-white mb-1">1</div> -->
                        <div class="line h-100"></div>
                    </div>
                    <div class="accordion flex-grow-1 ms-4 mb-4" id="accordionExample">
                        <div class="accordion-item rounded-3">
                            <div class="accordion-header rounded-3" id="headingOne">
                                <button class="accordion-button collapsed rounded-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                <!-- <button class="accordion-button collapsed rounded-top" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne"> -->
                                    Enter Source MySQL for Migration
                                </button> 
                            </div>
                            <div id="collapseOne" class="accordion-collapse rounded-bottom collapse show" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                                <div class="accordion-body border-1 rounded-3 pt-0">
                                    <div class="input-group">
                                        <div class="form-floating">
                                            <input type="text" class="form-control border-0 bg-white" id="mig-mysql-srcLabel" value="MySQL" value="-" required disabled>
                                            <label for="mig-mysql-srcLabel">Source</label>
                                        </div>
                                    </div>   
                                    <div class="input-group mb-3">
                                        <span class="input-group-text rounded-start"><i class="fa-solid fa-cloud"></i></span>
                                        <select class="form-select rounded-end" id="sourcePoint[provider]" name="sourcePoint[provider]">
                                            <option value="aws">AWS</option>
                                            <option value="gcp">GCP</option>
                                            <option value="ncp">NCP</option>
                                            <option value="on-premise">On-premise</option>
                                        </select>
                                    </div>
                                    
                                    <div class="input-group mb-3">
                                        <span class="input-group-text rounded-start"><i class="fa-solid fa-house"></i></span>
                                        <div class="form-floating">
                                            <input type="text" class="form-control rounded-end" id="mig-mysql-srcHost" name="sourcePoint[host]" placeholder="Host / IP" required>
                                            <label for="mig-mysql-srcHost">Host / IP</label>
                                        </div>
                                    </div>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text rounded-start"><i class="fa-solid fa-flag"></i></span>
                                        <div class="form-floating">
                                            <input type="text" class="form-control rounded-end" id="mig-mysql-srcPort" name="sourcePoint[port]" placeholder="Port" required>
                                            <label for="mig-mysql-srcPort">Port</label>
                                        </div>
                                    </div>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text rounded-start"><i class="fa-solid fa-user"></i></span>
                                        <div class="form-floating">
                                            <input type="text" class="form-control rounded-end" id="mig-mysql-srcUsername" name="sourcePoint[username]" placeholder="Username" required>
                                            <label for="mig-mysql-srcUsername">Username</label>
                                        </div>
                                    </div>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text rounded-start"><i class="fa-solid fa-lock"></i></span>
                                        <div class="form-floating">
                                            <input type="password" class="form-control rounded-end" id="mig-mysql-srcPassword" name="sourcePoint[password]" placeholder="Password" required>
                                            <label for="mig-mysql-srcPassword">Password</label>
                                        </div>
                                    </div>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text rounded-start"><i class="fa-solid fa-database"></i></span>
                                        <div class="form-floating">
                                            <input type="text" class="form-control rounded-end" id="mig-mysql-srcDatabase" name="sourcePoint[database]" placeholder="Database" required>
                                            <label for="mig-mysql-srcDatabase">Database</label>
                                        </div>
                                    </div>
                                    
                                    <div class="input-group">
                                        <button class="btn btn-dark btn-block rounded-3 float-end next-btn ms-auto" type="button" data-current="#collapseOne" data-next="#collapseTwo">
                                            Next
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex mb-1">
                    <div class="d-flex flex-column pr-4 align-items-center mt-2">
                        <button class="rounded-circle py-2 px-3 bg-secondary text-white mb-1 next-btn border-0 step-btn" type="button" data-target="#collapseTwo">
                            2
                        </button>
                        <!-- <div class="rounded-circle py-2 px-3 bg-secondary text-white mb-1">2</div> -->
                        <div class="line h-100"></div>
                    </div>
                    <div class="accordion flex-grow-1 ms-4 mb-4">
                        <div class="accordion-item rounded-3">
                            <div class="accordion-header"  id="headingTwo">
                                <button class="accordion-button collapsed rounded-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                <!-- <button class="accordion-button collapsed rounded-top" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo"> -->
                                    Diagnose Source MySQL
                                </button> 
                            </div>                            
                            <div id="collapseTwo" class="accordion-collapse rounded-bottom collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <div>
                                        <button class="btn btn-primary mb-3 rounded-3 float-end" id="sourceDiagnoseBtn" type="button">diagnose</button>
                                    </div>
                                    <div class="input-group mb-3">
                                        <textarea class="form-control rounded-1" id="sourceResult" name="resultText" rows="10" disabled></textarea>
                                    </div>
                                    <div class="input-group">
                                        <button class="btn btn-dark btn-block rounded-3 next-btn ms-auto" type="button" data-current="#collapseTwo" data-next="#collapseThree">Next</button>                            
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex mb-1">
                    <div class="d-flex flex-column pr-4 align-items-center mt-2">                        
                        <button class="rounded-circle py-2 px-3 bg-secondary text-white mb-1 next-btn border-0 step-btn" type="button" data-target="#collapseThree">
                            3
                        </button>
                        <!-- <div class="rounded-circle py-2 px-3 bg-secondary text-white mb-1">3</div> -->
                        <div class="line h-100"></div>
                    </div>
                    <div class="accordion flex-grow-1 ms-4 mb-4">
                        <div class="accordion-item rounded-3">
                            <div class="accordion-header rounded-3"  id="headingThree">
                                <button class="accordion-button collapsed rounded-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                <!-- <button class="accordion-button collapsed rounded-top" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseTwo"> -->
                                    Enter Target MySQL for Migration
                                </button> 
                            </div>                            
                            <div id="collapseThree" class="accordion-collapse rounded-bottom collapse" aria-labelledby="headingThree" data-bs-parent="#accordionExample">
                                <div class="accordion-body rounded-3 pt-0">
                                    <div class="input-group mb-3">
                                        <div class="form-floating">
                                            <input type="text" class="form-control border-0 bg-white" id="mig-mysql-targetHost" value="MySQL" value="-" required disabled>
                                            <label for="mig-mysql-targetHost">Target</label>
                                        </div>
                                    </div>  
                                    <div class="input-group mb-3">
                                        <span class="input-group-text rounded-start"><i class="fa-solid fa-cloud"></i></span>
                                        <select class="form-select rounded-end" id="targetPoint[provider]" name="targetPoint[provider]">
                                            <option value="aws">AWS</option>
                                            <option value="gcp">GCP</option>
                                            <option value="ncp">NCP</option>
                                            <option value="onpremise">On-premise</option>
                                        </select>
                                    </div>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text rounded-start"><i class="fa-solid fa-house"></i></span>
                                        <div class="form-floating">
                                            <input type="text" class="form-control rounded-end" id="mig-mysql-destHost" name="targetPoint[host]" placeholder="Host / IP" required>
                                            <label for="mig-mysql-destHost">Host / IP</label>
                                        </div>
                                    </div>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text rounded-start"><i class="fa-solid fa-flag"></i></span>
                                        <div class="form-floating">
                                            <input type="text" class="form-control rounded-end" id="mig-mysql-destPort" name="targetPoint[port]" placeholder="Port" required>
                                            <label for="mig-mysql-destPort">Port</label>
                                        </div>
                                    </div>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text rounded-start"><i class="fa-solid fa-user"></i></span>
                                        <div class="form-floating">
                                            <input type="text" class="form-control rounded-end" id="mig-mysql-destUsername" name="targetPoint[username]" placeholder="Username" required>
                                            <label for="mig-mysql-destUsername">Username</label>
                                        </div>
                                    </div>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text rounded-start"><i class="fa-solid fa-lock"></i></span>
                                        <div class="form-floating">
                                            <input type="password" class="form-control rounded-end" id="mig-mysql-destPassword" name="targetPoint[password]" placeholder="Password" required>
                                            <label for="mig-mysql-destPassword">Password</label>
                                        </div>
                                    </div>
                                    <div class="input-group mb-3">
                                        <span class="input-group-text rounded-start"><i class="fa-solid fa-database"></i></span>
                                        <div class="form-floating">
                                            <input type="text" class="form-control rounded-end" id="mig-mysql-destDatabase" name="targetPoint[database]" placeholder="Database" required>
                                            <label for="mig-mysql-destDatabase">Database</label>
                                        </div>
                                    </div>
                                    <div class="input-group">
                                        <button class="btn btn-dark btn-block rounded-3 ms-auto next-btn" type="button" data-current="#collapseThree" data-next="#collapseFour">Next</button>  
                                    </div>                            
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex mb-1">
                    <div class="d-flex flex-column pr-4 align-items-center mt-2">
                        <button class="rounded-circle py-2 px-3 bg-secondary text-white mb-1 next-btn border-0 step-btn" type="button" data-target="#collapseFour">
                            4
                        </button>
                        <!-- <div class="rounded-circle py-2 px-3 bg-secondary text-white mb-1">2</div> -->
                        <!-- <div class="line h-100"></div> -->
                    </div>
                    <div class="accordion flex-grow-1 ms-4 mb-4" id="accordionExample">
                        <div class="accordion-item rounded-3">
                            <div class="accordion-header rounded-3"  id="headingFour">
                                <button class="accordion-button collapsed rounded-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                <!-- <button class="accordion-button collapsed rounded-top" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseFour"> -->
                                    Diagnose Target MySQL
                                </button> 
                            </div>                            
                            <div id="collapseFour" class="accordion-collapse rounded-bottom collapse" aria-labelledby="headingFour" data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <div>
                                        <button class="btn btn-primary mb-3 rounded-3 float-end" id="targetDiagnoseBtn" type="button">diagnose</button>
                                    </div>
                                    <div class="input-group mb-3">
                                        <textarea class="form-control rounded-1" id="targetResult" name="resultText" rows="10" disabled></textarea>
                                    </div>
                                    <div class="input-group">
                                        <button class="btn btn-dark btn-block rounded-3 ms-auto next-btn" type="button" data-current="#collapseFour" data-next="#collapseFive">Next</button>                            
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary rounded-1" id="submitBtn">Submit</button>
        </form>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Next 버튼
        document.querySelectorAll(".next-btn").forEach(btn => {
            btn.addEventListener("click", e => {
            const current = document.querySelector(btn.dataset.current);
            const next = document.querySelector(btn.dataset.next);
        
            if (current && next) {
                bootstrap.Collapse.getOrCreateInstance(current).hide();
                bootstrap.Collapse.getOrCreateInstance(next).show();
            }
            });
        });

        document.getElementById("sourceDiagnoseBtn").addEventListener("click", (e) => {
            
            const url = "/diagnose/status"

            jsonData = {
                targetPoint: {
                    host: document.getElementById("mig-mysql-srcHost").value,
                    port: document.getElementById("mig-mysql-srcPort").value,
                    username: document.getElementById("mig-mysql-srcUsername").value,
                    password: document.getElementById("mig-mysql-srcPassword").value,
                    databaseName: document.getElementById("mig-mysql-srcDatabase").value,
                },
                time: 5
            }

            let req = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jsonData)
            };

            const sourceResult = document.getElementById('sourceResult');
            sourceResult.value = ""

            const btn = e.currentTarget
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>&nbsp;In progress..';

            fetch(url, req)
                .then(response => {
                    return response.json();
                })
                .then(json => {
                    sourceResult.value = json.Result;
                })
                .catch(reason => {
                    console.log(reason);
                    alert(reason);
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = 'Diagnose';
                });

            console.log("diagnose progressing...");
        });
    });
</script>